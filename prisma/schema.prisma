generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Usuario {
  id            String      @id @default(uuid())
  nomeCompleto  String
  supabaseId    String      @unique
  cpf           String?     @unique
  cnpj          String?     @unique
  dataNasc      DateTime?
  telefone      String
  genero        String?
  email         String      @unique
  senha         String
  matricula     String?
  codEmpresa    String?
  tipoUsuario   TipoUsuario
  role          Role
  status        Status      @default(ATIVO)
  aceitarTermos Boolean     @default(false)
  criadoEm      DateTime    @default(now())
  atualizadoEm  DateTime    @updatedAt
  ultimoLogin   DateTime?
  refreshToken  String?
  
  // CAMPOS PARA RECUPERAÇÃO DE SENHA
  tokenRecuperacao           String?   
  tokenRecuperacaoExp        DateTime? 
  tentativasRecuperacao      Int       @default(0)
  ultimaTentativaRecuperacao DateTime?
  
  // CAMPOS PARA AUDITORIA DE EMAILS
  emailVerificado      Boolean   @default(false)
  emailBoasVindasEnviado Boolean @default(false)
  dataEmailBoasVindas  DateTime?
  
  // RELACIONAMENTOS
  enderecos     Endereco[]
  empresa       Empresa?    @relation(fields: [codEmpresa], references: [id])
  
  @@index([tokenRecuperacao])
}

model Empresa {
  id       String    @id @default(uuid())
  nome     String
  criadoEm DateTime  @default(now())
  usuarios Usuario[]
}

model Endereco {
  id           String   @id @default(uuid())
  usuarioId    String
  logradouro   String
  numero       String
  bairro       String
  cidade       String
  estado       String
  cep          String
  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt
  usuario      Usuario  @relation(fields: [usuarioId], references: [id])
}

model LogEmail {
  id          String      @id @default(uuid())
  usuarioId   String?
  email       String
  tipoEmail   TipoEmail
  status      StatusEmail
  tentativas  Int         @default(1)
  erro        String?
  messageId   String?
  criadoEm    DateTime    @default(now())
  atualizadoEm DateTime   @updatedAt

  @@index([usuarioId])
  @@index([email])
  @@index([tipoEmail])
  @@index([criadoEm])
}

model LogSMS {
  id          String    @id @default(uuid())
  usuarioId   String?
  telefone    String
  tipoSMS     TipoSMS
  status      StatusSMS
  tentativas  Int       @default(1)
  erro        String?
  messageId   String?
  criadoEm    DateTime  @default(now())
  atualizadoEm DateTime @updatedAt

  @@index([usuarioId])
  @@index([telefone])
  @@index([tipoSMS])
  @@index([criadoEm])
}

enum TipoUsuario {
  PESSOA_FISICA
  PESSOA_JURIDICA
}

enum Role {
  ADMIN
  MODERADOR
  FINANCEIRO
  PROFESSOR
  EMPRESA
  PEDAGOGICO
  RECRUTADOR
  PSICOLOGO
  ALUNO_CANDIDATO
}

enum Status {
  ATIVO
  INATIVO
  BANIDO
  PENDENTE
  SUSPENSO
}

enum TipoEmail {
  BOAS_VINDAS
  RECUPERACAO_SENHA
  VERIFICACAO_EMAIL
  NOTIFICACAO_SISTEMA
}

enum StatusEmail {
  ENVIADO
  FALHA
  PENDENTE
}

enum TipoSMS {
  VERIFICACAO
  NOTIFICACAO
  MARKETING
}

enum StatusSMS {
  ENVIADO
  FALHA
  PENDENTE
}